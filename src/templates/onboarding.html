{% extends "base.html" %}

{% block title %}Get Started - Signal Sentinel{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-8rem)] flex flex-col">
    <!-- Progress Bar -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-2">
            {% for i in range(1, 5) %}
            <div class="flex items-center {% if i < 4 %}flex-1{% endif %}">
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-semibold text-sm
                    {% if i < step %}bg-sentinel-teal text-white
                    {% elif i == step %}bg-sentinel-indigo text-white ring-4 ring-sentinel-indigo/20
                    {% else %}bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400{% endif %}">
                    {% if i < step %}
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    {% else %}{{ i }}{% endif %}
                </div>
                {% if i < 4 %}
                <div class="flex-1 h-1 mx-3 {% if i < step %}bg-sentinel-teal{% else %}bg-gray-200 dark:bg-gray-700{% endif %}"></div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 px-1">
            <span class="w-10 text-center">Account</span>
            <span class="w-10 text-center">Holdings</span>
            <span class="w-10 text-center">Strategy</span>
            <span class="w-10 text-center">Monitor</span>
        </div>
    </div>

    <!-- Step Content -->
    <div class="flex-1">
        {% if step == 1 %}
        <!-- Step 1: Register/Login -->
        <div class="max-w-md mx-auto animate-fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-indigo-400 to-sentinel-indigo rounded-2xl flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-montserrat font-bold text-gray-900 dark:text-white mb-2">Welcome to Signal Sentinel</h1>
                <p class="text-gray-600 dark:text-gray-400">Create your account to start monitoring your portfolio</p>
            </div>

            <!-- Toggle between Register/Login -->
            <div class="flex bg-gray-100 dark:bg-gray-800 rounded-lg p-1 mb-6">
                <button type="button" id="showRegister" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm">
                    Register
                </button>
                <button type="button" id="showLogin" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                    Login
                </button>
            </div>

            <!-- Register Form -->
            <form id="registerForm" action="/onboarding/register" method="POST" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                    <input type="email" name="email" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-sentinel-indigo focus:border-transparent transition-colors"
                        placeholder="you@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" name="password" required minlength="8"
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-sentinel-indigo focus:border-transparent transition-colors"
                        placeholder="Min 8 characters">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Confirm Password</label>
                    <input type="password" name="password_confirm" required minlength="8"
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-sentinel-indigo focus:border-transparent transition-colors"
                        placeholder="Confirm password">
                </div>
                {% if error %}
                <div class="alert alert-error">
                    <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <span>{{ error }}</span>
                </div>
                {% endif %}
                <button type="submit" class="btn btn-primary w-full py-3">
                    Create Account
                </button>
            </form>

            <!-- Login Form (hidden by default) -->
            <form id="loginForm" action="/onboarding/login" method="POST" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                    <input type="email" name="email" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-sentinel-indigo focus:border-transparent transition-colors"
                        placeholder="you@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" name="password" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-sentinel-indigo focus:border-transparent transition-colors"
                        placeholder="Your password">
                </div>
                {% if error %}
                <div class="alert alert-error">
                    <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <span>{{ error }}</span>
                </div>
                {% endif %}
                <button type="submit" class="btn btn-primary w-full py-3">
                    Sign In
                </button>
            </form>
        </div>

        {% elif step == 2 %}
        <!-- Step 2: Import Holdings -->
        <div class="max-w-2xl mx-auto animate-fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-teal-400 to-sentinel-teal rounded-2xl flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-montserrat font-bold text-gray-900 dark:text-white mb-2">Import Your Holdings</h1>
                <p class="text-gray-600 dark:text-gray-400">Choose how you'd like to add your portfolio positions</p>
            </div>

            <div class="grid md:grid-cols-3 gap-4 mb-8">
                <!-- Option 1: CSV Upload -->
                <div class="bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 p-6 card-hover cursor-pointer hover:border-sentinel-indigo dark:hover:border-sentinel-indigo transition-colors"
                     onclick="showImportOption('csv')">
                    <div class="w-12 h-12 mb-4 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-1">Upload CSV</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Import from Schwab positions export</p>
                </div>

                <!-- Option 2: Connect Broker -->
                <div class="bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 p-6 card-hover cursor-pointer hover:border-sentinel-indigo dark:hover:border-sentinel-indigo transition-colors {% if not plaid_configured %}opacity-60{% endif %}"
                     onclick="{% if plaid_configured %}showImportOption('plaid'){% endif %}">
                    <div class="w-12 h-12 mb-4 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                        </svg>
                    </div>
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-1">Connect Broker</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        {% if plaid_configured %}Auto-sync via Plaid{% else %}Plaid not configured{% endif %}
                    </p>
                </div>

                <!-- Option 3: Manual Add -->
                <div class="bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 p-6 card-hover cursor-pointer hover:border-sentinel-indigo dark:hover:border-sentinel-indigo transition-colors"
                     onclick="showImportOption('manual')">
                    <div class="w-12 h-12 mb-4 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                    </div>
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-1">Add Manually</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Enter positions one by one</p>
                </div>
            </div>

            <!-- CSV Upload Panel -->
            <div id="csvPanel" class="hidden bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 animate-fade-in">
                <h3 class="font-semibold text-gray-900 dark:text-white mb-4">Upload Schwab CSV</h3>
                <form action="/onboarding/import/csv" method="POST" enctype="multipart/form-data">
                    <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-sentinel-indigo transition-colors">
                        <input type="file" name="file" accept=".csv" required class="hidden" id="csvFile" onchange="updateFileName(this)">
                        <label for="csvFile" class="cursor-pointer">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <span id="fileName" class="text-gray-600 dark:text-gray-400">Click to select or drag CSV file here</span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Export from Schwab: Accounts > Positions > Export</p>
                    <button type="submit" class="btn btn-primary w-full mt-4">Import Positions</button>
                </form>
            </div>

            <!-- Plaid Panel -->
            <div id="plaidPanel" class="hidden bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 animate-fade-in">
                <h3 class="font-semibold text-gray-900 dark:text-white mb-4">Connect Your Broker</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Securely connect your brokerage account to automatically sync positions.</p>
                <button type="button" onclick="initPlaidLink()" class="btn btn-primary w-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                    </svg>
                    Connect with Plaid
                </button>
            </div>

            <!-- Manual Add Panel -->
            <div id="manualPanel" class="hidden bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 animate-fade-in">
                <h3 class="font-semibold text-gray-900 dark:text-white mb-4">Add Position Manually</h3>
                <form action="/onboarding/import/manual" method="POST" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Symbol</label>
                            <input type="text" name="symbol" required placeholder="AAPL"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white uppercase">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Shares</label>
                            <input type="number" name="shares" required step="0.0001" min="0" placeholder="100"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cost Basis (per share)</label>
                        <input type="number" name="cost_basis" required step="0.01" min="0" placeholder="150.00"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" name="action" value="add_more" class="btn btn-secondary flex-1">Add & Continue</button>
                        <button type="submit" name="action" value="done" class="btn btn-primary flex-1">Add & Next Step</button>
                    </div>
                </form>

                {% if holdings_count > 0 %}
                <div class="mt-4 p-3 bg-sentinel-teal/10 text-sentinel-teal rounded-lg text-sm">
                    <strong>{{ holdings_count }}</strong> position(s) added so far
                </div>
                {% endif %}
            </div>

            <!-- Skip/Continue buttons -->
            <div class="flex justify-between mt-8">
                <a href="/onboarding?step=3" class="btn btn-ghost">Skip for now</a>
                {% if holdings_count > 0 %}
                <a href="/onboarding?step=3" class="btn btn-primary">Continue with {{ holdings_count }} position(s)</a>
                {% endif %}
            </div>
        </div>

        {% elif step == 3 %}
        <!-- Step 3: Strategy Preset Selection -->
        <div class="max-w-3xl mx-auto animate-fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-montserrat font-bold text-gray-900 dark:text-white mb-2">Choose Your Strategy</h1>
                <p class="text-gray-600 dark:text-gray-400">Select a preset that matches your investment style</p>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                {% for strategy in strategies %}
                <form method="POST" action="/onboarding/strategy/{{ strategy.id }}" class="contents">
                    <button type="submit" class="text-left bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 p-5 card-hover hover:border-sentinel-indigo dark:hover:border-sentinel-indigo transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <span class="px-2 py-0.5 text-xs rounded-full font-medium
                                {% if strategy.risk_level == 'conservative' %}bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300
                                {% elif strategy.risk_level == 'medium' %}bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-300
                                {% else %}bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300{% endif %}">
                                {{ strategy.risk_level }}
                            </span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">{{ strategy.rules|length }} rules</span>
                        </div>
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-2">{{ strategy.name }}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-3">{{ strategy.description }}</p>
                    </button>
                </form>
                {% endfor %}
            </div>

            <div class="flex justify-between">
                <a href="/onboarding?step=2" class="btn btn-ghost">Back</a>
                <a href="/onboarding?step=4" class="btn btn-secondary">Skip - I'll configure rules later</a>
            </div>
        </div>

        {% elif step == 4 %}
        <!-- Step 4: Start Monitoring Instructions -->
        <div class="max-w-2xl mx-auto animate-fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-sentinel-indigo to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-montserrat font-bold text-gray-900 dark:text-white mb-2">You're All Set!</h1>
                <p class="text-gray-600 dark:text-gray-400">Here's how to get the most out of Signal Sentinel</p>
            </div>

            <div class="space-y-4 mb-8">
                <!-- Telegram Setup -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 dark:text-white mb-1">Enable Telegram Alerts</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Get instant alerts on your phone when rules trigger</p>
                            <code class="block bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded text-xs font-mono text-gray-800 dark:text-gray-200">
                                invest notifications set-telegram YOUR_CHAT_ID
                            </code>
                        </div>
                    </div>
                </div>

                <!-- Run Monitor -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 dark:text-white mb-1">Start Monitoring</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Run the monitor to check your rules against current prices</p>
                            <code class="block bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded text-xs font-mono text-gray-800 dark:text-gray-200">
                                invest monitor run
                            </code>
                        </div>
                    </div>
                </div>

                <!-- Customize Rules -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 dark:text-white mb-1">Customize Your Rules</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Add custom rules or modify thresholds from the dashboard</p>
                            <code class="block bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded text-xs font-mono text-gray-800 dark:text-gray-200">
                                invest rules add "Buy the Dip" price_below_cost_pct 10
                            </code>
                        </div>
                    </div>
                </div>

                <!-- Rate Alerts -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 dark:text-white mb-1">Rate Alert Quality</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Help Signal Sentinel learn by rating alerts as useful, noise, or actionable</p>
                            <code class="block bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded text-xs font-mono text-gray-800 dark:text-gray-200">
                                invest alerts rate ALERT_ID useful
                            </code>
                        </div>
                    </div>
                </div>
            </div>

            <form action="/onboarding/complete" method="POST">
                <button type="submit" class="btn btn-primary w-full py-4 text-lg">
                    Go to Dashboard
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Step 1: Toggle between Register/Login
document.getElementById('showRegister')?.addEventListener('click', function() {
    document.getElementById('registerForm').classList.remove('hidden');
    document.getElementById('loginForm').classList.add('hidden');
    this.classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'shadow-sm');
    this.classList.remove('text-gray-600', 'dark:text-gray-400');
    document.getElementById('showLogin').classList.remove('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'shadow-sm');
    document.getElementById('showLogin').classList.add('text-gray-600', 'dark:text-gray-400');
});

document.getElementById('showLogin')?.addEventListener('click', function() {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerForm').classList.add('hidden');
    this.classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'shadow-sm');
    this.classList.remove('text-gray-600', 'dark:text-gray-400');
    document.getElementById('showRegister').classList.remove('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'shadow-sm');
    document.getElementById('showRegister').classList.add('text-gray-600', 'dark:text-gray-400');
});

// Step 2: Show import option panels
function showImportOption(option) {
    ['csv', 'plaid', 'manual'].forEach(opt => {
        document.getElementById(opt + 'Panel')?.classList.add('hidden');
    });
    document.getElementById(option + 'Panel')?.classList.remove('hidden');
}

function updateFileName(input) {
    const fileName = input.files[0]?.name || 'Click to select or drag CSV file here';
    document.getElementById('fileName').textContent = fileName;
}

// Plaid Link initialization
{% if plaid_configured %}
async function initPlaidLink() {
    try {
        const response = await fetch('/api/brokers/link/plaid/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        const handler = Plaid.create({
            token: data.link_token,
            onSuccess: async (public_token, metadata) => {
                await fetch('/api/brokers/link/exchange', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ public_token: public_token, broker_type: 'plaid' })
                });
                // Sync positions
                window.location.href = '/onboarding?step=3';
            },
            onExit: (err, metadata) => {
                if (err) console.error('Plaid Link error:', err);
            }
        });
        handler.open();
    } catch (error) {
        console.error('Failed to initialize Plaid:', error);
        alert('Failed to connect broker. Please try again.');
    }
}
{% endif %}
</script>

{% if plaid_configured %}
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
{% endif %}
{% endblock %}
